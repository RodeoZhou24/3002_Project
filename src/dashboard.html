<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åŠ¨æ€å®šä»·å¯è§†åŒ–é¢æ¿</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0b1221;
      --panel: #111827;
      --card: #111827;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --green: #10b981;
      --red: #ef4444;
      --amber: #f59e0b;
      --blue: #3b82f6;
      --purple: #8b5cf6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      gap: 12px;
    }
    .title {
      font-weight: 700;
      font-size: 1.1rem;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    button, label.button {
      border: 1px solid var(--border);
      background: #1f2937;
      color: var(--text);
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.primary {
      background: var(--green);
      border-color: var(--green);
      color: #0b1221;
    }
    input[type="file"] { display: none; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
    }
    .metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
    }
    .metric .value { font-size: 1.4rem; font-weight: 700; }
    .muted { color: var(--muted); }
    .badge {
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .b-green { background: rgba(16,185,129,0.15); color: var(--green); }
    .b-amber { background: rgba(245,158,11,0.15); color: var(--amber); }
    .b-red { background: rgba(239,68,68,0.15); color: var(--red); }
    .b-blue { background: rgba(59,130,246,0.15); color: var(--blue); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    th, td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th { color: var(--muted); font-weight: 600; }
    tr:hover { background: rgba(255,255,255,0.02); }
    .flex {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .section-title {
      font-weight: 700;
      margin-bottom: 4px;
    }
    .log-box {
      background: #000;
      color: #a5f3fc;
      font-family: "SFMono-Regular", Consolas, monospace;
      height: 220px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 10px;
      font-size: 0.85rem;
    }
    .pill { padding: 2px 8px; border-radius: 6px; border: 1px solid var(--border); }
    .chart-wrap { min-height: 320px; }
    footer {
      color: var(--muted);
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .hint { color: var(--amber); font-weight: 600; }
    @media (max-width: 900px) {
      header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">åŠ¨æ€å®šä»·å¯è§†åŒ–é¢æ¿</div>
      <div class="muted">è¯»å– C++ åç«¯äº§å‡ºçš„ CSV/æ—¥å¿—æˆ–ç”¨æˆ·ä¸Šä¼ çš„æ•°æ®æ–‡ä»¶</div>
    </div>
    <div class="controls">
      <label class="button" for="fileUpload">ğŸ“ ä¸Šä¼  CSV / æ—¥å¿—</label>
      <input id="fileUpload" type="file" accept=".csv,.txt" multiple />
      <button id="refreshBtn" class="button">ğŸ”„ é‡æ–°è¯»å– output/</button>
      <button id="demoBtn" class="button">ğŸ“Š ä½¿ç”¨å†…ç½®ç¤ºä¾‹</button>
      <span class="pill" id="sourceTag">æ•°æ®æº: æœªåŠ è½½</span>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="metric">
        <span>äº§å“æ•°</span>
        <span class="value" id="metricProducts">-</span>
      </div>
      <div class="muted" id="metricProductsHint">ç­‰å¾…æ•°æ®</div>
    </div>
    <div class="card">
      <div class="metric">
        <span>æ´»è·ƒå‘Šè­¦</span>
        <span class="value" id="metricAlerts">-</span>
      </div>
      <div class="muted" id="metricAlertsHint">ç­‰å¾…æ•°æ®</div>
    </div>
    <div class="card">
      <div class="metric">
        <span>æœ€åæ›´æ–°æ—¶é—´</span>
        <span class="value" id="metricUpdated">-</span>
      </div>
      <div class="muted">æ¥æºï¼šprice_trend_detailed.csv / pricing.log</div>
    </div>
  </div>

  <div class="grid">
    <div class="card" style="min-width: 300px;">
      <div class="section-title">äº§å“é€‰æ‹©</div>
      <select id="productSelect" style="width: 100%; padding: 8px; background: #1f2937; border: 1px solid var(--border); color: var(--text); border-radius: 8px;"></select>
      <div style="margin-top: 10px;" class="muted">é€‰æ‹©äº§å“ä»¥æŸ¥çœ‹ä»·æ ¼/éœ€æ±‚æ›²çº¿</div>
      <div id="productInfo" style="margin-top: 10px; line-height: 1.6;"></div>
    </div>
    <div class="card" style="grid-column: span 2;">
      <div class="section-title">ä»·æ ¼ & éœ€æ±‚è¶‹åŠ¿</div>
      <div class="chart-wrap">
        <canvas id="priceChart"></canvas>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card" style="grid-column: span 3;">
      <div class="section-title">å®šä»·å› å­åˆ†è§£ï¼ˆå–è¯¥å•†å“æœ€æ–°ä¸€æ¡è®°å½•ï¼‰</div>
      <table id="factorTable">
        <thead>
          <tr>
            <th>å› å­</th>
            <th>æ•°å€¼</th>
            <th>è¯´æ˜</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted" style="margin-top: 6px;">è‹¥ CSV æ— å› å­åˆ—ï¼Œè‡ªåŠ¨æ˜¾ç¤ºâ€œ-â€ã€‚å¯é€‰åˆ—ï¼šfactorStock,factorCompetitor,factorDemand,factorTime,adjustmentã€‚</div>
    </div>
  </div>

  <div class="grid">
    <div class="card" style="grid-column: span 2;">
      <div class="section-title">åº“å­˜å‘Šè­¦</div>
      <div class="muted">æ¥è‡ªé¢„æµ‹éœ€æ±‚ vs åº“å­˜çš„å‘Šè­¦çº§åˆ«</div>
      <table id="alertsTable">
        <thead>
          <tr>
            <th>äº§å“</th>
            <th>å½“å‰åº“å­˜</th>
            <th>é¢„æµ‹éœ€æ±‚</th>
            <th>å‘Šè­¦çº§åˆ«</th>
            <th>æœ€æ–°ä»·æ ¼</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card" style="grid-column: span 2;">
      <div class="section-title">å®šä»·ç»“æœ</div>
      <div class="muted">åŸºäº price_trend_detailed.csv ä¸­çš„ basePrice / finalPrice</div>
      <table id="pricingTable">
        <thead>
          <tr>
            <th>äº§å“</th>
            <th>æ—¥æœŸ</th>
            <th>åŸä»·</th>
            <th>æœ€ç»ˆä»·</th>
            <th>æ¶¨å¹…</th>
            <th>åº“å­˜</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="grid">
    <div class="card" style="grid-column: span 2;">
      <div class="section-title">è¿è¡Œæ—¥å¿— (pricing.log)</div>
      <div class="flex muted">
        <span>ä»…å±•ç¤ºæœ€è¿‘ 50 è¡Œï¼›æ–‡ä»¶ä¸å­˜åœ¨æ—¶è‡ªåŠ¨å¿½ç•¥ã€‚</span>
      </div>
      <div id="logBox" class="log-box">å°šæœªåŠ è½½æ—¥å¿—ã€‚</div>
    </div>
  </div>

  <footer>
    <span>ä½¿ç”¨æ–¹å¼ï¼šå°†æœ¬æ–‡ä»¶æ”¾åœ¨é¡¹ç›® `src/`ï¼Œè¿è¡Œåç«¯ç”Ÿæˆ `output/*.csv` ä¸ `output/pricing.log`ï¼Œåˆ·æ–°å³å¯æŸ¥çœ‹ã€‚æˆ–ç›´æ¥ä¸Šä¼  CSV/æ—¥å¿—æ–‡ä»¶ã€‚</span>
    <span class="hint" id="statusHint">çŠ¶æ€ï¼šç­‰å¾…æ•°æ®</span>
  </footer>

  <input type="file" id="hiddenCsvInput" accept=".csv,.txt" style="display:none;" />

  <!-- ä½¿ç”¨æŒ‡å—å¼¹çª— -->
  <div id="guideModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999;">
    <div style="width: min(600px, 90vw); background: #0f172a; border: 1px solid #1f2937; border-radius: 12px; padding: 18px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div style="font-weight: 700; font-size: 1.05rem;">ä½¿ç”¨æŒ‡å—</div>
        <button id="guideClose" class="button" style="border: none; background: #1f2937; color: #e5e7eb;">å…³é—­</button>
      </div>
      <ol style="padding-left: 18px; line_height: 1.7; color: #e5e7eb; margin: 0; font-size: 0.95rem;">
        <li>çœ‹ç°æˆç»“æœï¼šç›´æ¥ç‚¹å³ä¸Šâ€œğŸ”„ é‡æ–°è¯»å– output/â€ï¼Œè‡ªåŠ¨è¯»å– output ç›®å½•é‡Œçš„æ•°æ®ã€‚</li>
        <li>è‡ªå·±æ¢æ•°æ®ï¼šç‚¹â€œğŸ“ ä¸Šä¼  CSV / æ—¥å¿—â€ï¼Œé€‰é”€å”®æ•°æ® CSVï¼ˆprice_trend_detailed.csvï¼‰å’Œæ—¥å¿—ï¼ˆpricing.logï¼Œå¯é€‰ï¼‰ã€‚</li>
        <li>æ²¡æ•°æ®ä¹Ÿèƒ½çœ‹ï¼šç‚¹â€œğŸ“Š ä½¿ç”¨å†…ç½®ç¤ºä¾‹â€ï¼Œç«‹å³å±•ç¤ºç¤ºä¾‹å›¾è¡¨ã€‚</li>
        <li>åˆ‡æ¢å•†å“ï¼šå·¦ä¾§ä¸‹æ‹‰æ¡†åˆ‡æ¢äº§å“ï¼›å›¾ä¸Šé»„è‰²æ¡æ˜¯æ—ºå­£ï¼Œè¡¨æ ¼é‡Œèƒ½çœ‹åˆ°æ—ºå­£åŠ ä»·ç™¾åˆ†æ¯”ã€‚</li>
        <li>çœ‹ä¸åˆ°æ›´æ–°ï¼Ÿå¼ºåˆ¶åˆ·æ–°ï¼ˆCmd+Shift+R / Ctrl+F5ï¼‰æˆ–ç”¨æ— ç—•çª—å£ã€‚</li>
      </ol>
      <div style="margin-top: 12px; color: #94a3b8; font-size: 0.85rem;">å•†å®¶åªéœ€å‡†å¤‡ CSV æ”¾åœ¨ output æˆ–ä¸Šä¼ ï¼›å…¶ä½™æ“ä½œéƒ½åœ¨é¡µé¢æŒ‰é’®å®Œæˆï¼Œæ— éœ€ç¼–ç¨‹ã€‚å¯é€‰åˆ—ï¼šisPeakSeasonã€seasonalAdjustmentã€competitorPriceã€competitorGapã€‚</div>
    </div>
  </div>

  <script>
    const priceChartCtx = document.getElementById('priceChart').getContext('2d');
    let priceChart;

    const state = {
      rows: [],
      products: [],
      alerts: [],
      productMap: new Map(),
      logLines: [],
      source: 'æœªåŠ è½½',
      updatedAt: ''
    };

    const els = {
      productSelect: document.getElementById('productSelect'),
      productInfo: document.getElementById('productInfo'),
      alertsTable: document.querySelector('#alertsTable tbody'),
      pricingTable: document.querySelector('#pricingTable tbody'),
      logBox: document.getElementById('logBox'),
      sourceTag: document.getElementById('sourceTag'),
      metricProducts: document.getElementById('metricProducts'),
      metricProductsHint: document.getElementById('metricProductsHint'),
      metricAlerts: document.getElementById('metricAlerts'),
      metricAlertsHint: document.getElementById('metricAlertsHint'),
      metricUpdated: document.getElementById('metricUpdated'),
      statusHint: document.getElementById('statusHint')
    };

    const alertClass = (level) => {
      const upper = (level || '').toUpperCase();
      if (upper === 'CRITICAL' || upper === 'HIGH') return 'b-red';
      if (upper === 'MEDIUM') return 'b-amber';
      return 'b-green';
    };

    const parseBool = (val) => {
      if (val === undefined || val === null) return false;
      const v = String(val).toLowerCase();
      return v === 'true' || v === '1' || v === 'yes';
    };

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const cols = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h] = cols[i] !== undefined ? cols[i].trim() : '');
        return obj;
      });
    }

    function ingestRows(rows) {
      state.rows = rows.map(r => ({
        date: r.date,
        productId: r.productId,
        basePrice: Number(r.basePrice || 0),
        finalPrice: Number(r.finalPrice || r.adjusted_price || 0),
        stock: Number(r.stock || r.stock_level || 0),
        alertLevel: r.alertLevel || 'GREEN',
        sales: Number(r.sales || 0),
        predictedDemand: Number(r.predictedDemand || r.demand || 0),
        isPeakSeason: parseBool(r.isPeakSeason),
        seasonalAdjustment: Number(r.seasonalAdjustment || 0),
        competitorPrice: Number(r.competitorPrice || 0),
      competitorGap: Number(r.competitorGap || 0), // å·®å¼‚ç™¾åˆ†æ¯”ï¼ˆæœ¬ä»·-ç«ä»·ï¼‰/ç«ä»·
      factorStock: Number(r.factorStock || r.stockFactor || 0),
      factorCompetitor: Number(r.factorCompetitor || r.competitorFactor || 0),
      factorDemand: Number(r.factorDemand || r.demandFactor || 0),
      factorTime: Number(r.factorTime || r.timeFactor || 0),
      adjustment: Number(r.adjustment || 0)
      }));

      const productMap = new Map();
      state.rows.forEach(row => {
        if (!productMap.has(row.productId)) productMap.set(row.productId, []);
        productMap.get(row.productId).push(row);
      });
      productMap.forEach(list => list.sort((a, b) => a.date.localeCompare(b.date)));

      state.productMap = productMap;
      state.products = Array.from(productMap.keys());

      const alerts = [];
      productMap.forEach((list, pid) => {
        const last = list[list.length - 1];
        alerts.push({
          productId: pid,
          stock: last?.stock ?? 0,
          predictedDemand: last?.predictedDemand ?? 0,
          alertLevel: last?.alertLevel || 'GREEN',
          finalPrice: last?.finalPrice ?? 0
        });
      });
      state.alerts = alerts;
      state.updatedAt = new Date().toLocaleString();
      renderAll();
    }

    function renderProductSelect() {
      els.productSelect.innerHTML = '';
      if (state.products.length === 0) {
        els.productSelect.innerHTML = '<option>æ— äº§å“</option>';
        els.productInfo.innerHTML = '<span class="muted">å°šæœªåŠ è½½æ•°æ®</span>';
        return;
      }
      state.products.forEach(pid => {
        const opt = document.createElement('option');
        opt.value = pid;
        opt.textContent = pid;
        els.productSelect.appendChild(opt);
      });
      els.productSelect.value = state.products[0];
      renderProductInfo(state.products[0]);
    }

    function renderProductInfo(pid) {
      const list = state.productMap.get(pid) || [];
      const last = list[list.length - 1] || {};
      const peakFlag = last.isPeakSeason ? 'æ—ºå­£' : 'å¸¸è§„';
      const compGapPct = last.competitorGap
        ? (last.competitorGap * 100).toFixed(1)
        : (last.competitorPrice
            ? (((last.finalPrice || last.basePrice) - last.competitorPrice) / last.competitorPrice * 100).toFixed(1)
            : '0.0');
      els.productInfo.innerHTML = `
        <div>æœ€æ–°ä»·æ ¼ï¼š<strong>Â¥${(last.finalPrice || 0).toFixed(2)}</strong></div>
        <div>ç«å“ä»·æ ¼ï¼š${last.competitorPrice ? 'Â¥' + last.competitorPrice.toFixed(2) : 'æœªæä¾›'}</div>
        <div>ç›¸å¯¹ç«å“å·®å¼‚ï¼š${compGapPct}%</div>
        <div>æœ€æ–°åº“å­˜ï¼š${last.stock || 0}</div>
        <div>é¢„æµ‹éœ€æ±‚ï¼š${(last.predictedDemand || 0).toFixed(2)}</div>
        <div>å‘Šè­¦çº§åˆ«ï¼š<span class="badge ${alertClass(last.alertLevel)}">${(last.alertLevel || 'GREEN')}</span></div>
        <div>å­£èŠ‚çŠ¶æ€ï¼š<span class="badge ${last.isPeakSeason ? 'b-amber' : 'b-blue'}">${peakFlag}</span>
            è°ƒèŠ‚ï¼š${(last.seasonalAdjustment * 100).toFixed(1)}%</div>
      `;
      renderPriceChart(pid);
      renderFactors(last);
    }

    function renderPriceChart(pid) {
      const data = state.productMap.get(pid) || [];
      const labels = data.map(d => d.date);
      const priceSeries = data.map(d => d.finalPrice || d.basePrice);
      const salesSeries = data.map(d => d.sales || 0);
      const peakSeries = data.map(d => d.isPeakSeason ? Math.max(...priceSeries) * 1.05 : 0);
      const competitorSeries = data.map(d => d.competitorPrice || null);
      if (priceChart) priceChart.destroy();
      priceChart = new Chart(priceChartCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'ä»·æ ¼',
              data: priceSeries,
              borderColor: '#8b5cf6',
              backgroundColor: 'rgba(139,92,246,0.2)',
              tension: 0.35,
              yAxisID: 'y'
            },
            {
              label: 'é”€é‡',
              data: salesSeries,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59,130,246,0.15)',
              tension: 0.35,
              yAxisID: 'y1'
            },
            {
              label: 'ç«å“ä»·æ ¼',
              data: competitorSeries,
              borderColor: '#22d3ee',
              borderDash: [6,4],
              backgroundColor: 'rgba(34,211,238,0.08)',
              tension: 0.35,
              yAxisID: 'y',
              spanGaps: true
            },
            {
              label: 'æ—ºå­£åŒºé—´',
              data: peakSeries,
              type: 'bar',
              backgroundColor: 'rgba(245,158,11,0.18)',
              borderColor: 'rgba(245,158,11,0.4)',
              borderWidth: 0,
              yAxisID: 'y',
              barPercentage: 1.0,
              categoryPercentage: 1.0
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { color: '#e5e7eb' }, grid: { color: '#1f2937' } },
            y1: { position: 'right', beginAtZero: true, ticks: { color: '#e5e7eb' }, grid: { display: false } },
            x: { ticks: { color: '#e5e7eb' }, grid: { display: false } }
          },
          plugins: { legend: { labels: { color: '#e5e7eb' } } }
        }
      });
    }

    function renderAlerts() {
      els.alertsTable.innerHTML = '';
      state.alerts.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.productId}</td>
          <td>${a.stock}</td>
          <td>${a.predictedDemand.toFixed(2)}</td>
          <td><span class="badge ${alertClass(a.alertLevel)}">${a.alertLevel}</span></td>
          <td>Â¥${a.finalPrice.toFixed(2)}</td>
        `;
        els.alertsTable.appendChild(tr);
      });
    }

    function renderPricingTable() {
      els.pricingTable.innerHTML = '';
      state.productMap.forEach((list, pid) => {
        const last = list[list.length - 1];
        const base = last?.basePrice || 0;
        const finalP = last?.finalPrice || base;
        const change = base === 0 ? 0 : ((finalP - base) / base) * 100;
        const comp = last?.competitorPrice || 0;
        const gap = comp ? ((finalP - comp) / comp) * 100 : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${pid}</td>
          <td>${last?.date || '-'}</td>
          <td>Â¥${base.toFixed(2)}</td>
          <td>Â¥${finalP.toFixed(2)}</td>
          <td>${change.toFixed(2)}%</td>
          <td>${last?.stock ?? 0}</td>
          <td>${last?.isPeakSeason ? 'æ—ºå­£' : 'å¸¸è§„'}</td>
          <td>${((last?.seasonalAdjustment || 0) * 100).toFixed(1)}%</td>
          <td>${comp ? 'Â¥' + comp.toFixed(2) : '-'}</td>
          <td>${comp ? gap.toFixed(2) + '%' : '-'}</td>
        `;
        els.pricingTable.appendChild(tr);
      });
    }

    function renderFactors(last) {
      const tbody = document.querySelector('#factorTable tbody');
      tbody.innerHTML = '';
      if (!last) return;
      const rows = [
        ['åº“å­˜ä¸æ–°å“ (stock)', last.factorStock],
        ['ç«å“ (competitor)', last.factorCompetitor],
        ['éœ€æ±‚/è¡Œä¸º (demand)', last.factorDemand],
        ['å­£èŠ‚/æ—¶é—´ (time)', last.factorTime],
        ['æ€»è°ƒæ•´ (sum)', last.adjustment]
      ];
      rows.forEach(([label, val]) => {
        const tr = document.createElement('tr');
        const display = (val || val === 0) ? val.toFixed(3) : '-';
        tr.innerHTML = `<td>${label}</td><td>${display}</td><td></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderMetrics() {
      els.metricProducts.textContent = state.products.length || '-';
      els.metricProductsHint.textContent = state.products.length ? 'å·²åŠ è½½äº§å“' : 'ç­‰å¾…æ•°æ®';
      const activeAlerts = state.alerts.filter(a => (a.alertLevel || '').toUpperCase() !== 'GREEN').length;
      els.metricAlerts.textContent = activeAlerts;
      els.metricAlertsHint.textContent = activeAlerts > 0 ? 'è¯·å…³æ³¨åº“å­˜/éœ€æ±‚' : 'æ— å‘Šè­¦';
      els.metricUpdated.textContent = state.updatedAt || '-';
      els.sourceTag.textContent = `æ•°æ®æº: ${state.source}`;
      const hasPeak = state.rows.some(r => r.isPeakSeason);
      els.statusHint.textContent = state.products.length
        ? `çŠ¶æ€ï¼šæ•°æ®å·²åŠ è½½${hasPeak ? 'ï¼ˆå«æ—ºå­£åŒºé—´ï¼‰' : ''}`
        : 'çŠ¶æ€ï¼šç­‰å¾…æ•°æ®';
    }

    function renderLogs() {
      if (!state.logLines.length) {
        els.logBox.textContent = 'æœªæ‰¾åˆ° pricing.log æˆ–å°šæœªåŠ è½½ã€‚';
        return;
      }
      els.logBox.innerHTML = state.logLines.slice(-50).map(l => `<div>${l}</div>`).join('');
    }

    function renderAll() {
      renderProductSelect();
      renderAlerts();
      renderPricingTable();
      renderMetrics();
      renderLogs();
    }

    async function fetchText(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error('fetch failed');
      return await res.text();
    }

    async function loadFromOutput() {
      try {
        const csv = await fetchText('../output/price_trend_detailed.csv');
        const rows = parseCSV(csv);
        ingestRows(rows);
        state.source = 'output/price_trend_detailed.csv';
        try {
          const logText = await fetchText('../output/pricing.log');
          state.logLines = logText.trim().split(/\r?\n/);
        } catch (_) {
          state.logLines = [];
        }
        renderLogs();
      } catch (err) {
        state.status = 'error';
        state.source = 'æœªæ‰¾åˆ° output/price_trend_detailed.csvï¼Œè¯·ä¸Šä¼ ';
        renderMetrics();
        els.statusHint.textContent = 'çŠ¶æ€ï¼šæœªæ‰¾åˆ°é»˜è®¤æ–‡ä»¶ï¼Œè¯·ä¸Šä¼  CSV';
      }
    }

    function handleFileUpload(files) {
      const csvFile = Array.from(files).find(f => f.name.endsWith('.csv'));
      const logFile = Array.from(files).find(f => f.name.includes('log'));
      if (csvFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const rows = parseCSV(e.target.result);
          ingestRows(rows);
          state.source = `ä¸Šä¼ : ${csvFile.name}`;
          renderMetrics();
        };
        reader.readAsText(csvFile);
      }
      if (logFile) {
        const readerLog = new FileReader();
        readerLog.onload = (e) => {
          state.logLines = e.target.result.trim().split(/\r?\n/);
          renderLogs();
        };
        readerLog.readAsText(logFile);
      }
    }

    function loadDemo() {
      const demo = `date,productId,basePrice,finalPrice,stock,alertLevel,sales,predictedDemand
2025-10-01,P1001,2999,2999,100,GREEN,10,0
2025-10-02,P1001,2999,2999,85,GREEN,15,0
2025-10-03,P1001,2999,2999,73,GREEN,12,0
2025-10-04,P1001,2999,2999,55,GREEN,18,0
2025-10-05,P1001,2999,2999,35,GREEN,20,0
2025-10-06,P1001,2899,2899,21,GREEN,14,0
2025-10-07,P1001,2899,7906.31,5,CRITICAL,16,16.67
2025-10-01,P1002,5999,5999,50,GREEN,8,0
2025-10-02,P1002,5999,5999,40,GREEN,10,0
2025-10-03,P1002,5999,11579.50,28,GREEN,12,10`;
      ingestRows(parseCSV(demo));
      state.source = 'å†…ç½®ç¤ºä¾‹';
      state.logLines = [
        '=== Pricing System Started ===',
        '[Thread-demo] Started',
        '[demo] P1001: Â¥2899 -> Â¥7906.31 (+172.9%)',
        '[demo] P1002: Â¥5999 -> Â¥11579.5 (+93.1%)',
        '[Thread-demo] Completed: 2 products'
      ];
      renderAll();
    }

    // Event bindings
    els.productSelect.addEventListener('change', (e) => renderProductInfo(e.target.value));
    document.getElementById('refreshBtn').addEventListener('click', loadFromOutput);
    document.getElementById('demoBtn').addEventListener('click', loadDemo);
    document.getElementById('fileUpload').addEventListener('change', (e) => handleFileUpload(e.target.files));

    // Guide modal
    const guideModal = document.getElementById('guideModal');
    const guideClose = document.getElementById('guideClose');
    function openGuide() { guideModal.style.display = 'flex'; }
    function closeGuide() { guideModal.style.display = 'none'; }
    guideClose.addEventListener('click', closeGuide);
    // åˆå§‹å¼¹å‡ºä¸€æ¬¡
    window.addEventListener('load', openGuide);
    // ç‚¹å‡»é®ç½©å…³é—­
    guideModal.addEventListener('click', (e) => { if (e.target === guideModal) closeGuide(); });

    // Initial load attempt
    loadFromOutput();
  </script>
</body>
</html>